# テストケース

## テスト概要
精錬分割加工申込システムにおける `ingot_details` のバリデーションとエラーハンドリングのテストケース

## テスト環境
- Laravel バージョン: 5.8+
- PHP バージョン: 7.2+
- データベース: MySQL

## 1. 単体テスト (Unit Tests)

### 1.1 IngotDetail クラスのテスト

#### TC-U-001: IngotDetail インスタンス生成
**目的**: IngotDetail クラスが正しくインスタンス化されることを確認

| 項目 | 内容 |
|------|------|
| テストID | TC-U-001 |
| テスト名 | IngotDetail インスタンス生成 |
| 前提条件 | IngotDetail.js が読み込まれている |
| テスト手順 | 1. `new IngotDetail()` を実行<br>2. インスタンスのプロパティを確認 |
| 期待結果 | - インスタンスが生成される<br>- デフォルト値が設定されている |
| 優先度 | 高 |

#### TC-U-002: calculateUnitPrice() - 金・GDBブランド
**目的**: 金のGDBブランドの単価計算が正しいことを確認

| 項目 | 内容 |
|------|------|
| テストID | TC-U-002 |
| テスト名 | 金・GDBブランドの単価計算 |
| 前提条件 | IngotDetail インスタンスが存在する |
| テスト手順 | 1. type = '金'<br>2. is_gdb = 'はい'<br>3. gram = 500<br>4. splits_count_100g = 5<br>5. calculateUnitPrice() を実行 |
| 期待結果 | - unit_price = 177.272727<br>- fee_total_price = 97350 |
| 優先度 | 高 |

#### TC-U-003: calculateUnitPrice() - プラチナ
**目的**: プラチナの単価計算が正しいことを確認

| 項目 | 内容 |
|------|------|
| テストID | TC-U-003 |
| テスト名 | プラチナの単価計算 |
| 前提条件 | IngotDetail インスタンスが存在する |
| テスト手順 | 1. type = 'プラチナ'<br>2. is_gdb = 'はい'<br>3. gram = 1000<br>4. splits_count_100g = 10<br>5. calculateUnitPrice() を実行 |
| 期待結果 | - unit_price = 280<br>- fee_total_price = 308000 |
| 優先度 | 高 |

#### TC-U-004: calculateUnitPrice() - スクラップ
**目的**: スクラップの単価計算が正しいことを確認

| 項目 | 内容 |
|------|------|
| テストID | TC-U-004 |
| テスト名 | スクラップの単価計算 |
| 前提条件 | IngotDetail インスタンスが存在する |
| テスト手順 | 1. type = 'スクラップ'<br>2. gram = 150<br>3. splits_scrap_100g = 150<br>4. calculateUnitPrice() を実行 |
| 期待結果 | - unit_price = 265.9090909090909<br>- fee_total_price = 43898.5 |
| 優先度 | 高 |

#### TC-U-005: calculateUnitPrice() - 即分割100g
**目的**: 即分割100gの単価計算が正しいことを確認

| 項目 | 内容 |
|------|------|
| テストID | TC-U-005 |
| テスト名 | 即分割100gの単価計算 |
| 前提条件 | IngotDetail インスタンスが存在する |
| テスト手順 | 1. type = '金'<br>2. is_gdb = 'はい'<br>3. gram = 1000<br>4. immediate_split_count_100g = 10<br>5. calculateUnitPrice() を実行 |
| 期待結果 | - unit_price = 354.5454545454545<br>- fee_total_price = 390000 |
| 優先度 | 高 |

### 1.2 IngotTotal クラスのテスト

#### TC-U-006: addIngotDetail()
**目的**: インゴット詳細が正しく追加されることを確認

| 項目 | 内容 |
|------|------|
| テストID | TC-U-006 |
| テスト名 | インゴット詳細の追加 |
| 前提条件 | IngotTotal インスタンスが存在する |
| テスト手順 | 1. IngotDetail インスタンスを生成<br>2. addIngotDetail() を実行<br>3. ingotDetails 配列を確認 |
| 期待結果 | - ingotDetails 配列に要素が追加される<br>- 配列の長さが1増える |
| 優先度 | 高 |

#### TC-U-007: deleteRow()
**目的**: インゴット詳細が正しく削除されることを確認

| 項目 | 内容 |
|------|------|
| テストID | TC-U-007 |
| テスト名 | インゴット詳細の削除 |
| 前提条件 | IngotTotal に要素が存在する |
| テスト手順 | 1. deleteRow(element, index) を実行<br>2. ingotDetails 配列を確認 |
| 期待結果 | - 指定したインデックスの要素が削除される<br>- 配列の長さが1減る |
| 優先度 | 中 |

## 2. バリデーションテスト

### 2.1 フロントエンドバリデーション

#### TC-V-001: ingot_details が空の場合の送信防止
**目的**: ingot_details が空の場合、フォーム送信がブロックされることを確認

| 項目 | 内容 |
|------|------|
| テストID | TC-V-001 |
| テスト名 | 空の ingot_details 送信防止 |
| 前提条件 | フォームが表示されている |
| テスト手順 | 1. ingotDetailsInput の値を空にする<br>2. フォーム送信を試行 |
| 期待結果 | - アラート「インゴット詳細のデータがありません」が表示される<br>- フォーム送信がキャンセルされる |
| 優先度 | 高 |

#### TC-V-002: グラム数と分割数の不一致
**目的**: グラム数と分割数が一致しない場合、保存がブロックされることを確認

| 項目 | 内容 |
|------|------|
| テストID | TC-V-002 |
| テスト名 | グラム数と分割数の整合性チェック |
| 前提条件 | モーダルが開いている |
| テスト手順 | 1. gram = 500 を選択<br>2. splits_count_100g = 3 を選択（合計300g）<br>3. 保存ボタンをクリック |
| 期待結果 | - アラート「グラム数と分割数の合計が一致しません」が表示される<br>- 保存がキャンセルされる |
| 優先度 | 高 |

#### TC-V-003: 通常分割と即分割の混在禁止
**目的**: 通常分割と即分割が同時に選択された場合、保存がブロックされることを確認

| 項目 | 内容 |
|------|------|
| テストID | TC-V-003 |
| テスト名 | 通常分割と即分割の排他制御 |
| 前提条件 | モーダルが開いている |
| テスト手順 | 1. gram = 1000 を選択<br>2. splits_count_100g = 5 を選択<br>3. immediate_split_count_100g = 5 を選択<br>4. 保存ボタンをクリック |
| 期待結果 | - アラート「通常分割と即分割は同時に選択できません」が表示される<br>- 保存がキャンセルされる |
| 優先度 | 高 |

#### TC-V-004: スクラップのグラム数バリデーション
**目的**: スクラップのグラム数が100g未満の場合、保存がブロックされることを確認

| 項目 | 内容 |
|------|------|
| テストID | TC-V-004 |
| テスト名 | スクラップの最小グラム数チェック |
| 前提条件 | type = 'スクラップ' を選択 |
| テスト手順 | 1. splits_scrap_100g = 50 を入力<br>2. 保存ボタンをクリック |
| 期待結果 | - アラート「スクラップのグラム数を100g以上で入力してください」が表示される<br>- 保存がキャンセルされる |
| 優先度 | 中 |

### 2.2 バックエンドバリデーション

#### TC-V-005: ingot_details が [null] の場合の処理
**目的**: ingot_details が [null] でも処理が継続し、適切にエラーハンドリングされることを確認

| 項目 | 内容 |
|------|------|
| テストID | TC-V-005 |
| テスト名 | [null] ingot_details の処理 |
| 前提条件 | なし |
| テスト手順 | 1. ingot_details = "[null]" でPOSTリクエスト送信<br>2. レスポンスを確認 |
| 期待結果 | - DB保存は成功する（ingot_details: "[null]"）<br>- メール送信でエラーが発生<br>- エラーログが記録される<br>- GoogleChatに通知される<br>- サンクスページにリダイレクトされる |
| 優先度 | 最高 |

#### TC-V-006: ingot_details が空配列の場合
**目的**: ingot_details が空配列の場合の処理を確認

| 項目 | 内容 |
|------|------|
| テストID | TC-V-006 |
| テスト名 | 空配列 ingot_details の処理 |
| 前提条件 | なし |
| テスト手順 | 1. ingot_details = "[]" でPOSTリクエスト送信<br>2. レスポンスを確認 |
| 期待結果 | - DB保存は成功する（ingot_details: "[]"）<br>- メール送信は成功する（ループが0回）<br>- サンクスページにリダイレクトされる |
| 優先度 | 高 |

## 3. 統合テスト (Integration Tests)

### 3.1 正常系フローテスト

#### TC-I-001: 金インゴット申込フルフロー
**目的**: 金インゴットの申込が正常に完了することを確認

| 項目 | 内容 |
|------|------|
| テストID | TC-I-001 |
| テスト名 | 金インゴット申込フルフロー |
| 前提条件 | アプリケーションが起動している |
| テスト手順 | 1. `/refining_info` にアクセス<br>2. インゴット本数を入力<br>3. インゴット詳細を入力・保存<br>4. お客様情報を入力<br>5. フォーム送信 |
| 期待結果 | - DB保存成功<br>- 店舗側メール送信成功<br>- お客様側メール送信成功<br>- サンクスページ表示 |
| 優先度 | 最高 |

#### TC-I-002: スクラップ申込フルフロー
**目的**: スクラップの申込が正常に完了することを確認

| 項目 | 内容 |
|------|------|
| テストID | TC-I-002 |
| テスト名 | スクラップ申込フルフロー |
| 前提条件 | アプリケーションが起動している |
| テスト手順 | 1. `/refining_info` にアクセス<br>2. type = 'スクラップ' を選択<br>3. スクラップグラム数を入力・保存<br>4. お客様情報を入力<br>5. フォーム送信 |
| 期待結果 | - DB保存成功<br>- メール送信成功<br>- サンクスページ表示 |
| 優先度 | 高 |

#### TC-I-003: 複数インゴット申込フルフロー
**目的**: 複数インゴットの申込が正常に完了することを確認

| 項目 | 内容 |
|------|------|
| テストID | TC-I-003 |
| テスト名 | 複数インゴット申込フルフロー |
| 前提条件 | アプリケーションが起動している |
| テスト手順 | 1. インゴット本数 = 2 を入力<br>2. 1本目（金500g）を入力・保存<br>3. 2本目（プラチナ1000g）を入力・保存<br>4. お客様情報を入力<br>5. フォーム送信 |
| 期待結果 | - ingot_details に2つの要素が保存される<br>- メールに2つのインゴット情報が表示される<br>- サンクスページ表示 |
| 優先度 | 高 |

### 3.2 異常系フローテスト

#### TC-I-004: [null] ingot_details でのメール送信エラー
**目的**: [null] の ingot_details でメール送信エラーが適切にハンドリングされることを確認

| 項目 | 内容 |
|------|------|
| テストID | TC-I-004 |
| テスト名 | [null] ingot_details メール送信エラー |
| 前提条件 | なし |
| テスト手順 | 1. ingot_details = "[null]" でPOSTリクエスト送信 |
| 期待結果 | - DB保存成功<br>- メール送信でエラー発生<br>- エラーログに記録<br>- GoogleChatに通知<br>- サンクスページ表示（エラーは内部処理） |
| 優先度 | 最高 |

## 4. メールテンプレートテスト

### 4.1 店舗側メールテスト

#### TC-M-001: 正常データでの店舗側メール生成
**目的**: 正常なデータで店舗側メールが正しく生成されることを確認

| 項目 | 内容 |
|------|------|
| テストID | TC-M-001 |
| テスト名 | 店舗側メール正常生成 |
| 前提条件 | 正常な ingot_details が存在する |
| テスト手順 | 1. refining_info_plain_shop.blade.php を実行<br>2. 生成されたメール本文を確認 |
| 期待結果 | - すべてのインゴット詳細が表示される<br>- エラーが発生しない |
| 優先度 | 高 |

#### TC-M-002: [null] データでの店舗側メール生成エラー
**目的**: [null] データで店舗側メールがエラーになることを確認

| 項目 | 内容 |
|------|------|
| テストID | TC-M-002 |
| テスト名 | 店舗側メール [null] エラー |
| 前提条件 | ingot_details = [null] |
| テスト手順 | 1. refining_info_plain_shop.blade.php を実行<br>2. エラーを確認 |
| 期待結果 | - "Trying to access array offset on value of type null" エラーが発生する |
| 優先度 | 最高 |

## 5. パフォーマンステスト

#### TC-P-001: 大量インゴットデータの処理
**目的**: 大量のインゴットデータでも正常に処理できることを確認

| 項目 | 内容 |
|------|------|
| テストID | TC-P-001 |
| テスト名 | 大量インゴットデータ処理 |
| 前提条件 | なし |
| テスト手順 | 1. ingot_details に10個の要素を持つデータを送信<br>2. 処理時間を測定 |
| 期待結果 | - 処理時間が5秒以内<br>- メモリ使用量が正常範囲内 |
| 優先度 | 低 |

## テスト実行計画

### 優先度順
1. **最高優先度**: TC-V-005, TC-I-004, TC-M-002
   - [null] ingot_details の問題に直接関連
2. **高優先度**: TC-U-001 ~ TC-U-005, TC-V-001 ~ TC-V-003, TC-I-001 ~ TC-I-003, TC-M-001
   - コア機能の動作確認
3. **中優先度**: TC-V-004, TC-U-006, TC-U-007
   - 補助的な機能の確認
4. **低優先度**: TC-P-001
   - パフォーマンス確認

### 実行順序
1. 単体テスト（TC-U-xxx）
2. バリデーションテスト（TC-V-xxx）
3. メールテンプレートテスト（TC-M-xxx）
4. 統合テスト（TC-I-xxx）
5. パフォーマンステスト（TC-P-xxx）
